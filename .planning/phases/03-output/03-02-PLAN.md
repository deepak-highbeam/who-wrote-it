---
phase: 03-output
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - cmd/whowroteit/main.go
  - internal/github/prcomment.go
  - internal/github/prcomment_test.go
  - internal/survival/tracker.go
  - internal/survival/tracker_test.go
  - internal/store/schema.go
  - internal/store/sqlite.go
autonomous: true

must_haves:
  truths:
    - "`whowroteit pr-comment` generates and posts a collaboration summary comment to a GitHub PR"
    - "PR comment shows authorship breakdown by work type with insight callouts"
    - "PR comment shows per-file collaboration patterns for top notable files"
    - "Code survival tracking compares attributions against current git blame to measure AI code persistence"
    - "Survival rates are reportable by authorship level and work type"
  artifacts:
    - path: "internal/github/prcomment.go"
      provides: "GitHub PR comment generation and posting via GitHub REST API"
      exports: ["GenerateComment", "PostComment"]
    - path: "internal/survival/tracker.go"
      provides: "Code survival analysis comparing attributions against current git blame"
      exports: ["Analyze", "SurvivalReport"]
    - path: "internal/store/schema.go"
      provides: "Schema migration v4 for code_survival table"
      contains: "code_survival"
    - path: "cmd/whowroteit/main.go"
      provides: "pr-comment and survival cobra commands"
      contains: "prCommentCmd"
  key_links:
    - from: "internal/github/prcomment.go"
      to: "internal/report/report.go"
      via: "uses GenerateProject to get attribution data for the PR comment"
      pattern: "report\\.GenerateProject"
    - from: "internal/github/prcomment.go"
      to: "GitHub REST API"
      via: "POST /repos/{owner}/{repo}/issues/{number}/comments"
      pattern: "api.github.com"
    - from: "internal/survival/tracker.go"
      to: "internal/store/sqlite.go"
      via: "reads attributions and blame lines from store"
      pattern: "store\\.Query"
    - from: "cmd/whowroteit/main.go"
      to: "internal/github/prcomment.go"
      via: "prCommentCmd calls github.GenerateComment and PostComment"
      pattern: "github\\.PostComment"
---

<objective>
Add GitHub PR comment integration and code survival tracking to complete the output layer.

Purpose: Enable users to auto-post collaboration summary comments on PRs (showing authorship breakdown by work type and per-file patterns) and track whether AI-written code survives across subsequent commits.

Output: `internal/github/` package for PR comments, `internal/survival/` package for code survival analysis, updated CLI with `pr-comment` and `survival` commands, schema migration v4 for survival data.
</objective>

<execution_context>
@/Users/deepakbhimaraju/.claude/get-shit-done/workflows/execute-plan.md
@/Users/deepakbhimaraju/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-output/03-01-SUMMARY.md
@internal/store/sqlite.go
@internal/store/schema.go
@internal/metrics/calculator.go
@internal/gitint/blame.go
@internal/gitint/repository.go
@internal/report/report.go
@cmd/whowroteit/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: GitHub PR comment and code survival packages</name>
  <files>
    internal/github/prcomment.go
    internal/github/prcomment_test.go
    internal/survival/tracker.go
    internal/survival/tracker_test.go
    internal/store/schema.go
    internal/store/sqlite.go
  </files>
  <action>
**internal/github/prcomment.go** -- PR comment generation and posting:

- `GenerateComment(projectReport *report.ProjectReport) string` -- Produces a Markdown comment body with the phase context decisions (compact, insight-driven):
  1. Header: "## Who Wrote It - Collaboration Summary"
  2. Headline: "**Meaningful AI: XX.X%**" with spectrum counts inline
  3. Work-type breakdown table (Markdown table): Work Type | Tier | Files | AI% -- with brief insight callouts after the table. Callouts like: "Heavy AI usage in boilerplate (expected)" if boilerplate AI% > 80%, "Core logic is XX% human-written" if core_logic AI% < 30%, etc. Keep callouts to 1-3 lines max. Only show noteworthy patterns, not every work type.
  4. Top 3-5 notable files (sorted by AI% descending, skip files with < 3 events): File | Work Type | AI% | Collaboration Pattern (the authorship level with highest count)
  5. Footer: "_Generated by [who-wrote-it](https://github.com/anthropic/who-wrote-it)_"

- `PostComment(owner, repo string, prNumber int, body string, token string) error` -- POST to GitHub REST API `https://api.github.com/repos/{owner}/{repo}/issues/{prNumber}/comments` with Bearer token auth. Use standard `net/http`, no external GitHub SDK. Return error with status code on failure.

- `ParseGitHubRemote(remoteURL string) (owner, repo string, err error)` -- Parse GitHub remote URL (both HTTPS and SSH formats) to extract owner/repo. Patterns:
  - `https://github.com/{owner}/{repo}.git` or without `.git`
  - `git@github.com:{owner}/{repo}.git` or without `.git`

- `DetectPRNumber() (int, error)` -- Best-effort: check `GITHUB_PR_NUMBER` env var (CI), or try `gh pr view --json number` via exec.Command. Return error if neither works.

**internal/github/prcomment_test.go** -- Test GenerateComment with sample ProjectReport, test ParseGitHubRemote with both URL formats.

**internal/survival/tracker.go** -- Code survival analysis:

- `SurvivalReport` struct: TotalTracked int, SurvivedCount int, SurvivalRate float64, ByAuthorship map[string]SurvivalBreakdown, ByWorkType map[string]SurvivalBreakdown
- `SurvivalBreakdown` struct: Tracked int, Survived int, Rate float64
- `Analyze(s *store.Store, projectPath string) (*SurvivalReport, error)`:
  1. Query all attributions for the project that have AI authorship (fully_ai, ai_first_human_revised)
  2. For each attributed file, query current git_blame_lines from the store
  3. Compare: if the blame line's commit_hash matches any git_commit with has_coauthor_tag=1 (AI involved) AND the file was previously attributed as AI-authored, count as "survived"
  4. More practically: for each file with AI attribution, check if the file still exists in git_blame_lines. If yes, compare the content_hash of blame lines against the content_hash from the original session event. Lines where content_hash matches = survived. Lines where content_hash changed or line is gone = not survived.
  5. Aggregate by authorship level and work type
  6. If git_blame_lines is empty for a file (blame not yet run), skip that file (don't count as "not survived")

**Schema migration v4** (in internal/store/schema.go):
- Add `code_survival` table: id, file_path, project_path, attribution_id (FK to attributions), survived (boolean int), checked_at (timestamp), blame_commit_hash (text)
- Add `InsertSurvivalRecord` and `QuerySurvivalByProject` methods to store

**internal/survival/tracker_test.go** -- Test Analyze with mock store data: insert attributions + blame lines, verify survival counts.
  </action>
  <verify>
    Run `cd /Users/deepakbhimaraju/who-wrote-it && go build ./internal/github/ ./internal/survival/` -- compiles.
    Run `cd /Users/deepakbhimaraju/who-wrote-it && go test ./internal/github/ ./internal/survival/` -- tests pass.
  </verify>
  <done>
    GitHub PR comment can be generated from ProjectReport data in compact, insight-driven Markdown format.
    PostComment posts to GitHub REST API with token auth.
    Survival tracker analyzes AI code persistence against current blame data.
    Schema v4 migration adds code_survival table.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire pr-comment and survival commands into CLI</name>
  <files>
    cmd/whowroteit/main.go
  </files>
  <action>
Add two new commands to cmd/whowroteit/main.go:

**pr-comment command** (`whowroteit pr-comment`):
- Flags:
  - `--token string` -- GitHub token (default: reads `GITHUB_TOKEN` env var)
  - `--pr int` -- PR number (default: auto-detect via DetectPRNumber)
  - `--owner string` -- Repo owner (default: auto-detect from git remote)
  - `--repo string` -- Repo name (default: auto-detect from git remote)
  - `--db string` -- Override DB path (default: from config)
  - `--dry-run` -- Print comment body without posting
- Implementation:
  1. Load config, open store at dbPath
  2. Call `report.GenerateProject(dbPath)` to get ProjectReport
  3. Call `github.GenerateComment(projectReport)` to generate Markdown
  4. If --dry-run, print the Markdown and exit
  5. Auto-detect owner/repo from `git remote get-url origin` + ParseGitHubRemote (if not provided via flags)
  6. Auto-detect PR number if not provided
  7. Call `github.PostComment(owner, repo, prNumber, body, token)`
  8. Print "Comment posted to PR #N" on success

**survival command** (`whowroteit survival`):
- Flags:
  - `--db string` -- Override DB path
  - `--json` -- JSON output
- Implementation:
  1. Load config, get dbPath
  2. Open store, discover project path from attributions
  3. Call `survival.Analyze(store, projectPath)`
  4. Format output: summary table with overall survival rate, then breakdown by authorship level and work type
  5. Use ANSI formatting consistent with analyze command (reuse FormatJSON for --json)

Add both commands: `rootCmd.AddCommand(prCommentCmd())` and `rootCmd.AddCommand(survivalCmd())`
  </action>
  <verify>
    Run `cd /Users/deepakbhimaraju/who-wrote-it && go build -o /dev/null ./cmd/whowroteit/` -- builds.
    Run `cd /Users/deepakbhimaraju/who-wrote-it && go vet ./...` -- no issues.
    Run `cd /Users/deepakbhimaraju/who-wrote-it && go test ./...` -- all tests pass.
  </verify>
  <done>
    `whowroteit pr-comment` generates and posts PR collaboration summary (with --dry-run for preview).
    `whowroteit survival` shows AI code survival rates by authorship level and work type.
    All commands compile and full test suite passes.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles the entire project without errors
2. `go test ./...` all tests pass across all packages
3. `go vet ./...` no issues
4. `whowroteit pr-comment --help` shows flags (--token, --pr, --owner, --repo, --dry-run, --db)
5. `whowroteit survival --help` shows flags (--db, --json)
6. `whowroteit pr-comment --dry-run` generates valid Markdown (when run with populated DB)
</verification>

<success_criteria>
- PR comment generation produces compact, insight-driven Markdown with work-type breakdown and notable files
- PostComment hits GitHub REST API correctly with token auth
- Code survival analysis compares attributions against blame data and produces rates by authorship/work-type
- CLI commands are wired and compile
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-output/03-02-SUMMARY.md`
</output>
