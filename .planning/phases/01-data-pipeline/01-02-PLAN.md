---
phase: 01-data-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - internal/watcher/watcher.go
  - internal/watcher/debounce.go
  - internal/watcher/filter.go
  - internal/watcher/watcher_test.go
autonomous: true

must_haves:
  truths:
    - "File creation/modification/deletion in watched directory produces events in SQLite store"
    - "Rapid editor saves (multiple events within 100ms) produce exactly one debounced event"
    - "Creating a new subdirectory automatically starts watching it"
    - ".git, node_modules, and configured ignore patterns produce zero events"
    - "Watcher CPU stays below 2% during normal editor event storms"
  artifacts:
    - path: "internal/watcher/watcher.go"
      provides: "File system watcher integration with fsnotify"
      exports: ["Watcher", "New", "Start", "Stop"]
    - path: "internal/watcher/debounce.go"
      provides: "Event debouncing with configurable window"
      exports: ["Debouncer", "NewDebouncer"]
    - path: "internal/watcher/filter.go"
      provides: "Path filtering with glob patterns"
      exports: ["Filter", "NewFilter", "ShouldIgnore"]
    - path: "internal/watcher/watcher_test.go"
      provides: "Tests for debounce and filter logic"
  key_links:
    - from: "internal/daemon/daemon.go"
      to: "internal/watcher/watcher.go"
      via: "daemon starts watcher on startup"
      pattern: "watcher\\.Start"
    - from: "internal/watcher/watcher.go"
      to: "internal/store/sqlite.go"
      via: "watcher writes debounced events to store"
      pattern: "store\\.InsertFileEvent"
    - from: "internal/watcher/watcher.go"
      to: "internal/watcher/filter.go"
      via: "watcher checks filter before processing event"
      pattern: "filter\\.ShouldIgnore"
    - from: "internal/watcher/watcher.go"
      to: "internal/watcher/debounce.go"
      via: "watcher passes events through debouncer"
      pattern: "debouncer"
---

<objective>
Build the file system watcher subsystem that monitors project directories for file changes, debounces editor event storms, recursively watches new subdirectories, and persists filtered events to the SQLite store.

Purpose: File system events are the first input signal -- they tell us WHEN files changed. Combined with session data and git, they form the attribution timeline.
Output: A watcher that produces clean, debounced, filtered file events in the store.
</objective>

<execution_context>
@/Users/deepakbhimaraju/.claude/get-shit-done/workflows/execute-plan.md
@/Users/deepakbhimaraju/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-data-pipeline/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: File system watcher with fsnotify, debouncing, and filtering</name>
  <files>
    internal/watcher/watcher.go
    internal/watcher/debounce.go
    internal/watcher/filter.go
  </files>
  <action>
    **Filter (internal/watcher/filter.go):**
    - `Filter` struct with compiled ignore patterns (glob-based).
    - `NewFilter(patterns []string)` compiles patterns. Default patterns: `.git`, `node_modules`, `.idea`, `.vscode`, `__pycache__`, `*.swp`, `*.swo`, `*~`, `.DS_Store`, `build/`, `dist/`, `target/`.
    - `ShouldIgnore(path string) bool` checks path against all patterns. Use `filepath.Match` for globs. Also check if any path COMPONENT matches (not just the full path) -- so `foo/node_modules/bar.js` is caught by `node_modules` pattern.
    - Patterns loaded from config, merged with defaults.

    **Debouncer (internal/watcher/debounce.go):**
    - `Debouncer` struct with configurable window (default 100ms).
    - `NewDebouncer(window time.Duration, emit func(Event))` creates debouncer.
    - `Feed(event Event)` receives raw events. Groups by file path. For each file path, after `window` duration of no new events, emits the LAST event for that path. Uses a map of `path -> *time.Timer`.
    - If a new event arrives for the same path before the timer fires, reset the timer and update the stored event.
    - Thread-safe (mutex-protected map).
    - `Stop()` drains all pending timers and emits their events.

    **Watcher (internal/watcher/watcher.go):**
    - Use `github.com/fsnotify/fsnotify` for cross-platform file watching.
    - `Watcher` struct with fsnotify.Watcher, filter, debouncer, store, and context.
    - `New(store *store.Store, config *config.Config)` creates watcher.
    - `Start(ctx context.Context)` method:
      1. Walk the root watch path(s) recursively, add all directories to fsnotify (skip filtered dirs).
      2. Start goroutine reading fsnotify events channel.
      3. For each event: check filter (skip if ignored), check if Create event on a directory (add to fsnotify watcher for recursive watching), feed to debouncer.
      4. Debouncer emits to a callback that inserts into store.
    - `Stop()` stops debouncer (drains pending), closes fsnotify watcher.
    - Define `Event` struct: Path, Type (create/modify/delete), Timestamp.
    - Add `InsertFileEvent(event)` method to store (in store package, or accept it as a dependency).

    **Store integration:**
    - Add `InsertFileEvent(projectPath, filePath, eventType string, timestamp time.Time) error` method to the Store.
    - Add `CountFileEvents() (int64, error)` method for IPC status reporting.

    **Daemon integration:**
    - Wire watcher.Start() into daemon.Start() after store is open.
    - Wire watcher.Stop() into daemon.Stop() before store closes.
    - Pass watch paths from config.

    **Dependency:** `github.com/fsnotify/fsnotify`
  </action>
  <verify>
    `go build ./...` compiles.
    Start daemon watching a test directory.
    Create a file in watched dir: `echo "test" > /tmp/testwatch/hello.txt` -- verify event appears in SQLite: `sqlite3 ~/.whowroteit/whowroteit.db "SELECT * FROM file_events"`.
    Rapid saves: `for i in $(seq 1 10); do echo $i > /tmp/testwatch/hello.txt; done` -- verify only 1-2 events in store (debounce working), not 10.
    Create `.git/test` or `node_modules/test` -- verify no events in store (filter working).
    Create new subdir `mkdir /tmp/testwatch/sub && echo "test" > /tmp/testwatch/sub/file.txt` -- verify event for sub/file.txt appears (recursive watching).
  </verify>
  <done>
    File changes produce debounced events in store. Editor storms are collapsed. Ignored paths produce no events. New subdirectories are automatically watched.
  </done>
</task>

<task type="auto">
  <name>Task 2: Unit tests for debouncer and filter</name>
  <files>
    internal/watcher/watcher_test.go
  </files>
  <action>
    Write tests for the pure logic components (debouncer and filter). These have clean input/output contracts.

    **Filter tests:**
    - `TestFilterDefaultPatterns`: `.git/config`, `node_modules/package.json`, `.DS_Store` all return `ShouldIgnore=true`
    - `TestFilterAllowsNormalFiles`: `main.go`, `src/app.ts`, `README.md` return `ShouldIgnore=false`
    - `TestFilterNestedIgnore`: `deep/path/node_modules/foo.js` is caught even though `node_modules` is not the root component
    - `TestFilterCustomPatterns`: Add `*.log` pattern, verify `app.log` is ignored but `app.txt` is not

    **Debouncer tests:**
    - `TestDebouncerSingleEvent`: One event, wait for window, exactly one emission
    - `TestDebouncerBurstCollapse`: 10 events for same path within window, exactly one emission (the last)
    - `TestDebouncerDifferentPaths`: Events for path A and path B within window, two emissions (one per path)
    - `TestDebouncerStopDrains`: Feed events, call Stop() before window expires, pending events are emitted

    Use standard `testing` package. Use channels or sync.WaitGroup to handle async debouncer emissions in tests. Set debounce window to 50ms in tests for fast execution.
  </action>
  <verify>
    `go test ./internal/watcher/ -v -count=1` -- all tests pass.
    `go test ./internal/watcher/ -race` -- no race conditions detected.
  </verify>
  <done>
    Debouncer correctly collapses bursts and drains on stop. Filter correctly matches default and custom ignore patterns including nested paths. All tests pass with race detector.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` succeeds
2. `go test ./internal/watcher/ -v -race` -- all tests pass, no races
3. Manual integration test: start daemon, create/modify/delete files in watched dir, verify events in SQLite
4. Debounce test: rapid file saves produce collapsed events
5. Filter test: changes in .git/, node_modules/ produce zero events
6. Recursive test: new subdirectory creation triggers watching of that subdirectory
7. `./whowroteit status` now shows non-zero file_events_count after generating events
</verification>

<success_criteria>
- File creation, modification, deletion events flow into SQLite store (FSWT-01)
- Editor event storms are debounced to single events (FSWT-02)
- New subdirectories are automatically watched (FSWT-03)
- Configured paths are ignored (FSWT-04)
- Unit tests pass with race detector enabled
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-pipeline/01-02-SUMMARY.md`
</output>
